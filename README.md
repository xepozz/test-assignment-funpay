# Решение тестового задания для Fun Pay

## Тесты

Код покрыт на 99%. 1% – это исключение для неподдерживаемого модификатора.
Так как алгоритм парсинга и подстановки находятся в одном классе, нет возможности передать поддерживаемый модификатор в
парсере и неподдерживаемый в подстановщике.
Поэтому можно считать, что код покрыт на 100%

Для запуска тестов стоит выполнить следующие команды:

Установка зависимостей:

```shell
composer i
```

Запуск тестов

```shell
./vendor/bin/phpunit
```

Файлы на query builder написаны на PHPUnit и расположены в
файле [tests/QueryBuilderTest.php](tests/QueryBuilderTest.php).

Оригинальные тесты дописаны с минимальными изменения и запускаются с PHPUnit, вместе
с `QueryBuilderTest.php`: [tests/IntegrationTest.php](tests/IntegrationTest.php).

На задачу ушло около 3-х часов. Дополнительный час потребовался на поддержку рекурсивных условий.

## Резюме

Реализован алгоритм подстановки параметров в SQL запрос с дополнительным экранирование, поддержкой приведения типов и
поддержкой конструкций с условными операторами.

Дополнительно реализована возможность задавать условные операторы вложено.

### Модификаторы

Реализован парсер модификаторов:

| Модификатор | Описание                                  | Типы данных                                                                 |
|-------------|-------------------------------------------|-----------------------------------------------------------------------------|
| `?`         | Люые значения                             | null, int, float, string, list of <null, int, float, string>                | 
| `?d`        | Числовые значения                         | null, int, float                                                            | 
| `?#`        | Идентификаторы или список идентификаторов | string, list of string                                                      | 
| `?a`        | Список или хэш-мап значений               | list of <null, int, float, string> or hashmap of <null, int, float, string> | 

### Условные операторы

Условные операторы реализованы с поддержкой всех вышеперечисленных модификаторов внутри себя.

Условные операторы заключается в фигурные скобки и одной возможной подстановкой внутри, например:

```sql
SELECT *
FROM users {
WHERE id = ?}
```

Возможные результаты приведения запроса к финальному запросу:

| Запрос                               | Параметры                                                             | Результат                          |
|--------------------------------------|-----------------------------------------------------------------------|------------------------------------|
| `SELECT * FROM users {WHERE id = ?}` | `[]`                                                                  | Ошибка, параметр обязателен        |
| `SELECT * FROM users {WHERE id = ?}` | `[5]`                                                                 | `SELECT * FROM users WHERE id = 5` |
| `SELECT * FROM users {WHERE id = ?}` | `[\Xepozz\FunpayTestAssignment\ModifierEnum::CONDITIONAL_BLOCK_SKIP]` | `SELECT * FROM users`              |

### Дополнительно реализована поддержка вложенных условных операторов

Возможные результаты приведения запроса к финальному запросу:

| Запрос                                              | Параметры                                                                | Результат                                               |
|-----------------------------------------------------|--------------------------------------------------------------------------|---------------------------------------------------------|
| `SELECT * FROM users {WHERE id = ? AND {name = ?}}` | `[]`                                                                     | Ошибка, параметр обязателен                             |
| `SELECT * FROM users {WHERE id = ? AND {name = ?}}` | `[5]`                                                                    | Ошибка, параметр обязателен                             |
| `SELECT * FROM users {WHERE id = ? AND {name = ?}}` | `[5, \Xepozz\FunpayTestAssignment\ModifierEnum::CONDITIONAL_BLOCK_SKIP]` | `SELECT * FROM users WHERE id = 5`                      |
| `SELECT * FROM users {WHERE id = ? AND {name = ?}}` | `[5, 'Dmitrii']`                                                         | `SELECT * FROM users WHERE id = 5 AND name = 'Dmitrii'` |

### Тестовое задание

<details>
<summary>
Описание тестового задания
</summary>
<pre>
Тестовое задание. Написать функцию формирования sql-запросов (MySQL) из шаблона и значений параметров.

Места вставки значений в шаблон помечаются вопросительным знаком, после которого может следовать спецификатор
преобразования.
Спецификаторы:
?d - конвертация в целое число
?f - конвертация в число с плавающей точкой
?a - массив значений
?# - идентификатор или массив идентификаторов

Если спецификатор не указан, то используется тип переданного значения, но допускаются только типы string, int, float,
bool (приводится к 0 или 1) и null.
Параметры ?, ?d, ?f могут принимать значения null (в этом случае в шаблон вставляется NULL).
Строки и идентификаторы автоматически экранируются.

Массив (параметр ?a) преобразуется либо в список значений через запятую (список), либо в пары идентификатор и значение
через запятую (ассоциативный массив).
Каждое значение из массива форматируется в зависимости от его типа (идентично универсальному параметру без
спецификатора).

Также необходимо реализовать условные блоки, помечаемые фигурными скобками.
Если внутри условного блока есть хотя бы один параметр со специальным значением, то блок не попадает в сформированный
запрос.
Специальное значение должно возвращаться методом skip. Нужно выбрать подходящее значение на своё усмотрение.
Условные блоки не могут быть вложенными.

При ошибках в шаблонах или значениях выбрасывать исключения.

Для упрощения задачи предполагается, что в передаваемом шаблоне не будут использоваться комментарии sql.

В файле Database.php находится заготовка класса с заглушками в виде исключений. Нужно реализовать методы buildQuery и
skip.
В файле DatabaseTest.php находятся примеры (тесты). Тесты обязательно должны быть успешными (в противном случае код
рассматриваться не будет).

Код должен работать с php 8.3.
</pre>
</details>
